!function(){"use strict";function t(t){switch(t){case"SPADE":return"icons/spade.svg";case"CLUB":return"icons/club.svg";case"DIAMOND":return"icons/diamond.svg";case"HEART":return"icons/heart.svg";default:throw Error("No image for data type: "+t)}}class s{constructor(t){this.tableEl=$("#logs-table-body")[0],this.numReplicas=t}updateCommitIndex(t,s){for(var e=0;e<=s;e++){var i=this.tableEl.rows[e];if(!i)throw Error("Cannot commit an index that is not in table.");i.cells[t].classList.add("committed")}}insertValue(s,e,i,r){var h=this.tableEl.rows[e];if(!h){h=this.tableEl.insertRow(e);for(var a=0;a<this.numReplicas;a++)h.insertCell(a)}var n=h.cells[s],c=(d3.select(n).append("img").attr("class","table-data").attr("src",t(r)),document.createElement("div"));c.textContent=i,c.classList.add("table-term"),n.appendChild(c)}purgeValues(t,s,e){for(var i=s;i<e;i++){var r=this.tableEl.rows[i];if(!r)throw Error("Failed to purge values for "+t+" from "+s+" to "+e+": row missing at index "+i);for(var h=r.cells[t];h.firstChild;)h.removeChild(h.firstChild)}}}class e{constructor(t,s,e,i,r,h,a){this.id=this.makeid(),this.radius=t,this.x=s,this.y=e,this.vx=i,this.vy=r,this.sender=h,this.receiver=a,this.dropped=!1}makeid(){for(var t="",s="abcdefghijklmnopqrstuvwxyz",e=0;e<5;e++)t+=s.charAt(Math.floor(Math.random()*s.length));return t}init(){this.group=d3.select("svg").append("g").attr("id",this.id),this.el=this.group.append("circle"),this.el.attr("cx",this.x),this.el.attr("cy",this.y),this.el.attr("r",this.radius),$("#"+this.id).click(function(){this.dropped=!0,$("#"+this.id).toggleClass("dropped-message"),this.icon&&this.icon.remove()}.bind(this))}cleanup(){this.group.remove()}handleFrame(){this.x=this.x+this.vx,this.y=this.y+this.vy,this.el.attr("cx",this.x),this.el.attr("cy",this.y)}}class i{constructor(t,s,e,i){this.radius=t,this.v=s,this.jitter=e,this.entities=i}getComponentVelocities(t,s){t=this.entities[t],s=this.entities[s];var e=t.x,i=t.y,r=s.x-e,h=s.y-i,a=Math.atan(Math.abs(h/r)),n=this.v+Math.random()*this.jitter,c=n*Math.cos(a),d=n*Math.sin(a);return r<0&&(c*=-1),h<0&&(d*=-1),[c,d]}getX(t){return this.entities[t].x}getY(t){return this.entities[t].y}}class r{constructor(t){this.radius=t}containsMessage(t){var s=this.x-t.x,e=this.y-t.y;return Math.sqrt(s*s+e*e)<this.radius+t.radius}}class h extends e{constructor(t,s,e,i,r,h,a,n,c,d){super(i,r,h,a,n,c,d),this.term=t,this.lastLogIndex=s,this.lastLogTerm=e}init(){super.init(),this.el.remove(),this.icon=this.group.append("svg:image").attr("width",2*this.radius).attr("height",2*this.radius).attr("xlink:href","icons/question.svg"),this.setImgPosition()}setImgPosition(){var t=this.x-this.radius,s=this.y-this.radius;this.icon.attr("transform","translate("+t+", "+s+")")}handleFrame(){super.handleFrame(),this.setImgPosition()}}class a extends i{constructor(t,s,e,i){super(t,s,e,i)}get(t,s,e,i,r){var a=super.getComponentVelocities(s,r);return new h(t,e,i,this.radius,super.getX(s),super.getY(s),a[0],a[1],s,r)}}class n extends e{constructor(t,s,e,i,r,h,a,n,c){super(e,i,r,h,a,n,c),this.term=t,this.voteGranted=s}init(){super.init(),this.el.remove();var t=this.voteGranted?"icons/check.svg":"icons/x.svg";this.icon=this.group.append("svg:image").attr("width",2*this.radius).attr("height",2*this.radius).attr("xlink:href",t),this.setImgPosition()}handleFrame(){super.handleFrame(),this.setImgPosition()}setImgPosition(){var t=this.x-this.radius,s=this.y-this.radius;this.icon.attr("transform","translate("+t+", "+s+")")}}class c extends i{constructor(t,s,e,i){super(t,s,e,i)}get(t,s,e,i){var r=super.getComponentVelocities(e,i);return new n(t,s,this.radius,super.getX(e),super.getY(e),r[0],r[1],e,i)}}class d extends e{constructor(t,s,e,i,r,h,a,n,c,d,o,l){super(h,a,n,c,d,o,l),this.term=t,this.prevLogIndex=s,this.prevLogTerm=e,this.entries=i,this.leaderCommit=r}init(){super.init(),this.el.remove();var t=this.entries.length>0?"icons/data.svg":"icons/heartbeat.svg";this.icon=this.group.append("svg:image").attr("width",2*this.radius).attr("height",2*this.radius).attr("xlink:href",t),this.setImgPosition()}handleFrame(){super.handleFrame(),this.setImgPosition()}setImgPosition(){var t=this.x-this.radius,s=this.y-this.radius;this.icon.attr("transform","translate("+t+", "+s+")")}}class o extends i{constructor(t,s,e,i){super(t,s,e,i)}get(t,s,e,i,r,h,a){var n=super.getComponentVelocities(s,a);return new d(t,e,i,r,h,this.radius,super.getX(s),super.getY(s),n[0],n[1],s,a)}}class l extends e{constructor(t,s,e,i,r,h,a,n,c,d){super(e,i,r,h,a,n,c),this.term=t,this.success=s,this.requestId=d}init(){super.init(),this.el.remove();var t=this.success?"icons/check.svg":"icons/x.svg";this.icon=this.group.append("svg:image").attr("width",2*this.radius).attr("height",2*this.radius).attr("xlink:href",t),this.setImgPosition()}handleFrame(){super.handleFrame(),this.setImgPosition()}setImgPosition(){var t=this.x-this.radius,s=this.y-this.radius;this.icon.attr("transform","translate("+t+", "+s+")")}}class u extends i{constructor(t,s,e,i){super(t,s,e,i)}get(t,s,e,i,r){var h=super.getComponentVelocities(e,i);return new l(t,s,this.radius,super.getX(e),super.getY(e),h[0],h[1],e,i,r)}}class m extends e{constructor(t,s,e,i,r,h,a,n){super(s,e,i,r,h,a,n),this.data=t}init(){super.init(),this.el.remove(),this.icon=this.group.append("svg:image").attr("width",2*this.radius).attr("height",2*this.radius).attr("xlink:href",t(this.data)),this.setImgPosition()}handleFrame(){super.handleFrame(),this.setImgPosition()}setImgPosition(){var t=this.x-this.radius,s=this.y-this.radius;this.icon.attr("transform","translate("+t+", "+s+")")}}class p extends i{constructor(t,s,e,i){super(t,s,e,i)}get(t,s,e){var i=super.getComponentVelocities(s,e);return new m(t,this.radius,super.getX(s),super.getY(s),i[0],i[1],s,e)}}class g extends r{constructor(t,s,e,i,r,h,a,n,c,d,o,l){super(s),this.id=t,this.radius=s,this.x=e,this.y=i,this.otherReplicaIds=r,this.requestVoteRequestFactory=h,this.requestVoteResponseFactory=a,this.appendEntriesRequestFactory=n,this.appendEntriesResponseFactory=c,this.messageManager=d,this.tableUpdater=o,this.minElectionFrames=l,this.pendingRequests={},this.currentTerm=0,this.votedFor=null,this.log=[],this.commitIndex=-1,this.lastApplied=-1,this.nextIndex=null,this.matchIndex=null,this.framesSinceAppendEntries=null,this.voteCount=0,this.up=!0,this.MAX_FRAMES_SINCE_APPEND_ENTRIES=360}init(){this.resetElectionTimer(),this.group=d3.select("svg").append("g").attr("id",this.id+"-group"),this.circle=this.group.append("circle"),this.circle.attr("cx",this.x),this.circle.attr("cy",this.y),this.circle.attr("r",this.radius),this.circle.attr("class","replica-follower"),this.circle.attr("id",this.id),this.group.append("text").attr("dx",this.x-10).attr("dy",this.y+10).attr("class","replica-label").attr("id",this.id+"-label").text(this.id),this.arc=d3.arc().innerRadius(30).outerRadius(35).startAngle(0).endAngle(Math.PI),this.path=this.group.append("path").attr("class","timer-top").attr("d",this.arc).attr("transform","translate("+this.x+","+this.y+")"),$("#"+this.id+"-group").click(function(){this.up=!this.up,$("#"+this.id).toggleClass("replica-down"),$("#"+this.id+"-label").toggleClass("replica-down-label")}.bind(this))}resetElectionTimer(){this.framesInElection=this.minElectionFrames+Math.round(Math.random()*this.minElectionFrames),this.electionFramesPassed=0}isLeader(){return this.up&&null!=this.nextIndex}handleFrame(){if(this.up){if(this.isLeader())return this.framesSinceAppendEntries++,void(this.framesSinceAppendEntries==this.MAX_FRAMES_SINCE_APPEND_ENTRIES&&this.sendHeartbeat());var t=2*Math.PI-2*Math.PI*this.electionFramesPassed/this.framesInElection;this.arc.endAngle(t),this.path.attr("d",this.arc),this.electionFramesPassed==this.framesInElection?this.beginElection():this.electionFramesPassed++}}beginElection(){this.circle.attr("class","replica-candidate"),this.currentTerm++,this.votedFor=this.id,this.voteCount++,this.otherReplicaIds.forEach(function(t){this.requestVote(t)}.bind(this)),this.resetElectionTimer()}requestVote(t){var s=this.log.length-1,e=s>-1?this.log[s][1]:0,i=this.requestVoteRequestFactory.get(this.currentTerm,this.id,s,e,t);i.init(),this.messageManager.schedule(i)}handleMessage(t){if(this.up)switch(t.constructor){case h:this.handleRequestVoteRequest(t);break;case n:this.handleRequestVoteResponse(t);break;case d:this.handleAppendEntriesRequest(t);break;case l:this.handleAppendEntriesResponse(t);break;case m:this.handleDataRequest(t)}}handleDataRequest(t){if(this.isLeader()){var s=[t.data,this.currentTerm];this.addToLog(s),this.sendAppendNewEntries([s])}}prevEntriesMatch(t){var s=t.prevLogIndex;if(s<0)return!0;var e=this.log[s];return!!e&&e[1]==t.prevLogTerm}handleAppendEntriesRequest(t){var s=!0;if(t.term<this.currentTerm?s=!1:this.prevEntriesMatch(t)||(s=!1),t.term>this.currentTerm&&(this.currentTerm=t.term,this.becomeFollower()),s){for(var e=t.prevLogIndex+1,i=e,r=0;r<t.entries.length;r++){i=e+r;var h=t.entries[r];i>this.log.length-1?this.addToLog(h):this.log[i][1]!=h[1]&&(this.purgeLog(i),this.addToLog(h))}t.leaderCommit>this.commitIndex&&this.setCommitIndex(Math.min(t.leaderCommit,i)),this.resetElectionTimer()}var a=this.appendEntriesResponseFactory.get(this.currentTerm,s,this.id,t.sender,t.id);a.init(),this.messageManager.schedule(a)}handleAppendEntriesResponse(t){var s=this.pendingRequests[t.requestId];if(t.term>this.currentTerm&&(this.currentTerm=t.term,this.becomeFollower()),this.isLeader())if(t.success){var e=null!=s.prevLogIndex?s.prevLogIndex:-1;this.nextIndex[t.sender]=e+s.entries.length+1,this.matchIndex[t.sender]=e+s.entries.length;for(var i=this.otherReplicaIds.length+1,r=Math.round(i/2),h=1;h<s.entries.length+1;h++){var a=h+e;if(!(a<=this.commitIndex)&&(!this.log[a]||this.log[a][1]==this.currentTerm))for(var n=1,c=0;c<this.nextIndex.length;c++)if(c!=this.id&&this.matchIndex[c]>=a&&++n>=r){this.setCommitIndex(a);break}}}else this.nextIndex[t.sender]>0&&this.nextIndex[t.sender]--,this.retryAppendEntries(t.sender);else;delete this.pendingRequests[t.requestId]}handleRequestVoteRequest(t){var s=!0;t.term<this.currentTerm?s=!1:t.term==this.currentTerm&&null!=this.votedFor&&this.votedFor!=t.sender?s=!1:this.isCandidateLogUpToDate(t)||(s=!1),t.term>this.currentTerm&&this.currentTerm++;var e=this.requestVoteResponseFactory.get(this.currentTerm,s,this.id,t.sender);e.init(),this.messageManager.schedule(e),s&&(this.votedFor=t.sender,this.becomeFollower())}becomeFollower(){this.circle.attr("class","replica-follower"),this.nextIndex=null,this.matchIndex=null,this.framesSinceAppendEntries=null}isCandidateLogUpToDate(t){var s=this.log.length,e=0==s?0:s-1,i=0==s?null:this.log[e][1];return i!=t.lastLogTerm?t.lastLogTerm>=i:t.lastLogIndex>=e}handleRequestVoteResponse(t){if(t.voteGranted&&t.term==this.currentTerm){if(this.isLeader())return;this.voteCount++;var s=Math.round((this.otherReplicaIds.length+1)/2);if(this.voteCount>=s){this.circle.attr("class","replica-leader");var e=this.log.length-1;this.nextIndex=[0],this.matchIndex=[0],this.otherReplicaIds.forEach(function(t){this.nextIndex.push(0),this.matchIndex.push(0)}.bind(this));for(var i=e+1,r=0;r<this.otherReplicaIds.length;r++)this.nextIndex[r]=i;this.arc.endAngle(0),this.path.attr("d",this.arc),this.sendHeartbeat()}}else t.term>this.currentTerm&&(this.currentTerm=t.term)}retryAppendEntries(t){for(var s=this.nextIndex[t]-1,e=s<0?null:this.log[s][1],i=[],r=s+1;r<this.log.length;r++)i.push(this.log[r]);var h=this.appendEntriesRequestFactory.get(this.currentTerm,this.id,s,e,i,this.commitIndex,t);this.pendingRequests[h.id]=h,h.init(),this.messageManager.schedule(h)}sendAppendNewEntries(t){var s=this.log.length<2?-1:this.log.length-2,e=s<0?null:this.log[s][1];this.otherReplicaIds.forEach(function(i){var r=this.appendEntriesRequestFactory.get(this.currentTerm,this.id,s,e,t,this.commitIndex,i);this.pendingRequests[r.id]=r,r.init(),this.messageManager.schedule(r)}.bind(this)),this.framesSinceAppendEntries=0}sendHeartbeat(){this.sendAppendNewEntries([])}setCommitIndex(t){this.commitIndex=t,this.tableUpdater.updateCommitIndex(this.id,t)}addToLog(t){var s=t[0],e=t[1];this.log.push([s,e]),this.tableUpdater.insertValue(this.id,this.log.length-1,e,s)}purgeLog(t){var s=this.log.length;this.log=this.log.slice(0,t),this.tableUpdater.purgeValues(this.id,t,s)}}class v{constructor(t){this.replicas=t}getLeader(){for(var t=0;t<this.replicas.length;t++){var s=this.replicas[t];if(s.isLeader())return s.id}return null}}class f{constructor(t){this.messages=[],this.receivers=t}schedule(t){this.messages.push(t)}handleFrame(){var t=[];this.messages.forEach(function(s){s.dropped?s.cleanup():(s.handleFrame(),t.push(s))}),this.messages=t,this.deliverArrivals()}deliverArrivals(){if(0!=this.messages.length){var t=[],s=this.messages.slice(0);this.messages=[],s.forEach(function(s){var e=this.receivers[s.receiver];e.containsMessage(s)?(e.handleMessage(s),s.cleanup()):t.push(s)}.bind(this)),this.messages=this.messages.concat(t)}}}class F{constructor(t,s,e,i,r,h,a,n,c){this.entities=t,this.clientFactory=s,this.clientIds={},this.clientFrames={},this.maxClients=e,this.framesBeforeAdd=i,this.minClientFrames=r,this.maxClientFrames=h,this.planeLength=a,this.replicaPlaneLength=n,this.clientRadius=c}handleFrame(){for(var t in Object.keys(this.clientIds).length<this.maxClients&&Math.random()<1/this.framesBeforeAdd&&this.addClient(),this.clientIds)this.clientFrames[t]--,0==this.clientFrames[t]&&this.removeClient(t)}addClient(){var t=this.getRandomCoordinates(),s=this.clientFactory.get(t[0],t[1]);s.init(),this.clientIds[s.id]=s;var e=this.minClientFrames+Math.round(Math.random()*(this.maxClientFrames-this.minClientFrames));this.clientFrames[s.id]=e,this.entities[s.id]=s}getRandomCoordinates(){var t,s=this.clientRadius,e=this.planeLength-this.clientRadius,i=Math.round(Math.random()*(e-s))+s,r=this.planeLength/2-this.replicaPlaneLength/2,h=r+this.replicaPlaneLength;if(i<r-this.clientRadius||i>h+this.clientRadius)t=Math.round(Math.random()*(e-s))+s;else if(Math.random()<.5){var a=this.clientRadius,n=r-this.clientRadius;t=Math.round(Math.random()*(n-a))+a}else{a=r+this.replicaPlaneLength+this.clientRadius,n=this.planeLength-this.clientRadius;t=Math.round(Math.random()*(n-a))+a}return[i,t]}removeClient(t){delete this.clientFrames[t],this.clientIds[t].cleanup(),delete this.clientIds[t],delete this.entities[t]}}class M extends r{constructor(t,s,e,i,r,h,a,n){super(s),this.id=t,this.radius=s,this.x=e,this.y=i,this.messageManager=r,this.dataRequestFactory=h,this.avgFramesBetweenMessages=a,this.dataRequestRouter=n}init(){this.group=d3.select("svg").append("g"),this.circle=this.group.append("circle"),this.circle.attr("cx",this.x),this.circle.attr("cy",this.y),this.circle.attr("r",this.radius),this.circle.attr("class","client"),this.circle.attr("id",this.id),this.circle.attr("display","none"),this.appear()}cleanup(){this.disappear(),window.setTimeout(function(){this.group.remove()}.bind(this),1520)}handleFrame(){Math.random()<1/this.avgFramesBetweenMessages&&this.sendDataRequest()}appear(){$("#"+this.id).fadeIn(1500)}disappear(){$("#"+this.id).fadeOut(1500)}sendDataRequest(){var t=this.dataRequestRouter.getLeader();if(null!=t){var s=["SPADE","CLUB","HEART","DIAMOND"],e=s[Math.round(Math.random()*(s.length-1))],i=this.dataRequestFactory.get(e,this.id,t);i.init(),this.messageManager.schedule(i)}}handleMessage(t){}}class w{constructor(t,s,e,i,r){this.radius=t,this.messageManager=s,this.dataRequestFactory=e,this.avgFramesBetweenMessages=i,this.dataRequestRouter=r}get(t,s){return new M(this.makeid(),this.radius,t,s,this.messageManager,this.dataRequestFactory,this.avgFramesBetweenMessages,this.dataRequestRouter)}makeid(){for(var t="",s="abcdefghijklmnopqrstuvwxyz",e=0;e<5;e++)t+=s.charAt(Math.floor(Math.random()*s.length));return t}}var E,R,b,C,T,A,P,y,k,V,D,S,N,x=!1,q=(new Date).getTime(),U=1e3/60,_=[],B={},H=400,O=300,L=20,G=30,z=16,X=8,J=4,K=20,Q=240,W=1,Z=60,Y=600,I=900;function j(){if(!x){window.requestAnimationFrame(j);var t=(new Date).getTime();t-q>U&&(q=t,D.handleFrame(),S.handleFrame(),Object.keys(B).forEach(function(t){B[t].handleFrame()}))}}$(document).ready(function(){$("#pause-button").click(function(){(x=!x)||window.requestAnimationFrame(j)}),function(){$("#animation-holder").height(H),$("#animation-holder").width(H),C=new s(3),d3.select("svg");var t=H/2,e=O/2-G-L,i=e*Math.sqrt(3),r=[t,t-e],h=t+(i*Math.sqrt(3)/2-e),n=[t-i/2,h],d=[t+i/2,h],l=(d[0]-n[0])/(J/2+X)*2,m=Math.round(15*l);V=new v(_),D=new f(B,V),T=new a(z,X,J,B),A=new c(z,X,J,B),P=new o(z,X,J,B),y=new u(z,X,J,B),k=new p(z,X,J,B),N=new w(K,D,k,Q,V),S=new F(B,N,W,Z,Y,I,H,O,K),E=new g(0,G,n[0],n[1],[1,2],T,A,P,y,D,C,m),B[0]=E,_.push(E),E.init(),R=new g(1,G,d[0],d[1],[0,2],T,A,P,y,D,C,m),B[1]=R,_.push(R),R.init(),b=new g(2,G,r[0],r[1],[0,1],T,A,P,y,D,C,m),B[2]=b,_.push(b),b.init()}(),window.requestAnimationFrame(j)})}();